<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1900 NgajiYuk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        .arabic { font-family: 'Amiri', serif; }
        .sticky-header { position: sticky; top: 0; z-index: 50; }
        .tab-active { border-bottom: 4px solid #10b981; color: #065f46; font-weight: bold; }
        html { scroll-behavior: smooth; }
        .btn-kloter-active { background-color: #047857; color: white; border-color: #047857; }
    </style>
</head>
<body class="bg-slate-50 font-['Inter']">

    <nav class="bg-emerald-700 p-4 text-white shadow-lg sticky-header">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold italic tracking-tighter">üìñ 1900 NGAJIYUK - Tadarus 30 Juz</h1>
            <div class="text-[10px] bg-emerald-800 px-3 py-1 rounded-full border border-emerald-600">Online</div>
        </div>
    </nav>

    <div class="bg-white shadow-sm mb-4 border-b">
        <div class="container mx-auto flex">
            <button onclick="switchTab('dash')" id="tab-dash" class="flex-1 py-4 text-center tab-active transition-all">Dashboard</button>
            <button onclick="switchTab('juz')" id="tab-juz" class="flex-1 py-4 text-center tab-active transition-all">Jadwal Juz</button>
            <button onclick="switchTab('surah')" id="tab-surah" class="flex-1 py-4 text-center text-slate-500 transition-all">Daftar Surah</button>
        </div>
    </div>

   <!-- <section id="dashboard-area" class="container mx-auto px-4 mb-4"></section> -->
    <section id="section-dash" class="container mx-auto px-4 pb-10">
        <div id="stat-cards" class="grid grid-cols-2 gap-3 mb-6">
            </div>
        
        <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200 mb-6">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm">
                <span class="text-xl">üìä</span> Kontribusi Pekan Ini
            </h3>
            <div id="weekly-contribution-container">
                </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-200">
            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm">
                <span class="text-xl">üèÜ</span> Top Readers (Nama Unik)
            </h3>
            <div id="top-readers" class="space-y-2 text-sm">
                </div>
        </div>
    </section>

    <section id="section-juz" class="container mx-auto p-4 hidden">
        <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-bold text-slate-800">Pilih Jadwal Juz</h2>
                <div id="kloter-selector" class="flex gap-2 overflow-x-auto pb-2 w-full md:w-auto"></div>
            </div>
            
            <div id="juz-grid" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-10 gap-2">
                <div class="col-span-full text-center py-4 text-slate-400 italic">Memuat data kloter...</div>
            </div>
        </div>
    </section>

    <section id="section-surah" class="container mx-auto p-4 hidden">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="surah-grid"></div>
    </section>

    <section id="read-section" class="container mx-auto p-4 hidden">
        <div id="quran-container" class="max-w-4xl mx-auto space-y-4 pb-20"></div>
    </section>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwv1u4s7BNPLUeVY5r_eS2AdEZ-tFdQz8D1D8zVYa5Wf6jjLuBqn1vrGLPsZ5sPPiuO9A/exec';
        let databaseGlobal = [];
        let currentSelectedKloter = null;

        async function init() {
            const grid = document.getElementById('juz-grid');
            try {
                const response = await fetch(scriptURL);
                databaseGlobal = await response.json();
                
                if (databaseGlobal.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center text-orange-500 font-bold">Data masih kosong!</div>`;
                    return;
                }

                // Logika Penentuan Kloter Aktif
                const kloters = [...new Set(databaseGlobal.map(item => item.kloter))];
                
                // Cari kloter pertama yang BELUM khatam 100%
                for (let k of kloters) {
                    const dataK = databaseGlobal.filter(d => d.kloter === k);
                    const isKhatam = dataK.filter(d => d.nama.includes("‚úÖ")).length === 30;
                    if (!isKhatam) {
                        currentSelectedKloter = k;
                        break;
                    }
                }
                
                // Jika semua kloter sudah khatam, pilih kloter terakhir
                if (!currentSelectedKloter) currentSelectedKloter = kloters[kloters.length - 1];
                renderDashboard();
                renderJuzGrid();
                renderUI();
            } catch (e) {
                grid.innerHTML = `<div class="col-span-full text-center p-4 text-red-600">Gagal memuat data!</div>`;
            }
        }

        function renderUI() {
            const kloters = [...new Set(databaseGlobal.map(item => item.kloter))];
            const dash = document.getElementById('dashboard-area');
            const selector = document.getElementById('kloter-selector');
            
            dash.innerHTML = '<h2 class="font-bold text-slate-700 mb-3 px-1">Capaian Khataman Aktif</h2>';
            selector.innerHTML = '';

            kloters.forEach(k => {
                const dataK = databaseGlobal.filter(d => d.kloter === k);
                const selesai = dataK.filter(d => d.nama.includes("‚úÖ")).length;
                const terisi = dataK.filter(d => d.nama !== "").length;
                const persen = Math.round((selesai / 30) * 100);
                
                // HANYA munculkan kloter di Dashboard & Selector jika belum khatam 100%
                if (persen < 100) {
                    // Render Dashboard
                    dash.innerHTML += `
                        <div class="mb-3 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="flex justify-between text-xs mb-2">
                                <span class="font-bold">Kloter ${k} (${terisi}/30 Terisi)</span>
                                <span class="text-emerald-600 font-bold">${persen}% Khatam</span>
                            </div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div class="bg-emerald-500 h-full transition-all duration-500" style="width: ${persen}%"></div>
                            </div>
                        </div>`;

                    // Render Selector
                    const btn = document.createElement('button');
                    btn.className = `px-4 py-2 rounded-full border text-xs font-bold transition-all whitespace-nowrap ${currentSelectedKloter == k ? 'btn-kloter-active' : 'bg-white text-slate-600 border-slate-200'}`;
                    btn.innerText = `Kloter ${k}`;
                    btn.onclick = () => {
                        currentSelectedKloter = k;
                        renderUI();
                    };
                    selector.appendChild(btn);
                }
            });

            // Jika semua kloter sudah khatam, tampilkan pesan di dashboard
            if (dash.innerHTML === '<h2 class="font-bold text-slate-700 mb-3 px-1">Capaian Khataman Aktif</h2>') {
                dash.innerHTML += `<div class="p-4 bg-emerald-100 text-emerald-700 rounded-xl text-sm font-bold text-center">üéâ Semua kloter saat ini telah khatam!</div>`;
            }

            // Render Grid Juz
            const grid = document.getElementById('juz-grid');
            grid.innerHTML = '';
            
            databaseGlobal.filter(d => d.kloter == currentSelectedKloter).forEach(item => {
                const isTaken = item.nama !== "";
                const isDone = item.nama.includes("‚úÖ");
                const card = document.createElement('div');
                card.className = `p-3 rounded-xl border-2 text-center transition-all cursor-pointer ${isTaken ? 'bg-slate-100 border-slate-300' : 'bg-emerald-50 border-emerald-200 hover:border-emerald-500 shadow-sm'}`;
                card.innerHTML = `
                    <div class="text-[10px] font-bold text-emerald-700">JUZ</div>
                    <div class="text-lg font-black text-slate-800">${item.juz}</div>
                    <div class="text-[9px] truncate mt-1 ${isDone ? 'text-emerald-600 font-bold' : 'text-slate-500'}">
                        ${isTaken ? item.nama : 'Tersedia'}
                    </div>`;
                card.onclick = () => handleAction(item.kloter, item.juz, isTaken, item.nama);
                grid.appendChild(card);
            });
        }


        function renderDashboard() {
            // 1. STATISTIK TOTAL (NAMA UNIQUE)
            const allNames = databaseGlobal
                .filter(d => d.nama !== "")
                .map(d => d.nama.replace("‚úÖ", "").trim());
            const uniqueParticipants = [...new Set(allNames)];
            const totalSelesai = databaseGlobal.filter(d => d.nama.includes("‚úÖ")).length;

            document.getElementById('stat-cards').innerHTML = `
                <div class="bg-emerald-600 text-white p-4 rounded-2xl shadow-md">
                    <div class="text-[10px] opacity-80 uppercase font-bold tracking-wider">Peserta Bergabung</div>
                    <div class="text-2xl font-black">${uniqueParticipants.length} <span class="text-[10px] font-normal">Orang</span></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Total Juz Khatam</div>
                    <div class="text-2xl font-black text-emerald-700">${totalSelesai} <span class="text-[10px] font-normal text-slate-400">Juz</span></div>
                </div>
            `;

            // 2. KONTRIBUSI PEKANAN (Target 30 Juz per Kloter)
            const latestKloter = Math.max(...databaseGlobal.map(d => d.kloter));
            const dataPekanIni = databaseGlobal.filter(d => d.kloter === latestKloter);
            const selesaiPekanIni = dataPekanIni.filter(d => d.nama.includes("‚úÖ")).length;
            const persenPekanIni = Math.round((selesaiPekanIni / 30) * 100);

            document.getElementById('weekly-contribution-container').innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-slate-600">Pekan Ini (Kloter ${latestKloter})</span>
                    <span class="text-sm font-black text-emerald-600">${persenPekanIni}%</span>
                </div>
                <div class="w-full bg-slate-100 h-4 rounded-full overflow-hidden border border-slate-200">
                    <div class="bg-emerald-500 h-full transition-all duration-1000" style="width: ${persenPekanIni}%"></div>
                </div>
                <p class="text-[9px] text-slate-400 mt-2 font-medium italic">*Setiap kloter memiliki target khataman 30 Juz.</p>
            `;

            // 3. TOP READER (UNIQUE)
            const counts = {};
            databaseGlobal.forEach(d => {
                if(d.nama.includes("‚úÖ")) {
                    const cleanName = d.nama.replace("‚úÖ", "").trim();
                    counts[cleanName] = (counts[cleanName] || 0) + 1;
                }
            });
            const top = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const topDiv = document.getElementById('top-readers');
            topDiv.innerHTML = top.length ? '' : '<p class="text-slate-400 italic">Belum ada setoran.</p>';
            top.forEach(([name, count], idx) => {
                topDiv.innerHTML += `
                    <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                        <span><span class="font-bold text-emerald-700 mr-2">#${idx+1}</span> ${name}</span>
                        <span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-[10px] font-bold">${count} Juz</span>
                    </div>`;
            });
        }

        function renderJuzGrid() {
            const kloters = [...new Set(databaseGlobal.map(item => item.kloter))];
            const selector = document.getElementById('kloter-selector');
            selector.innerHTML = '';
            
            kloters.forEach(k => {
                const dataK = databaseGlobal.filter(d => d.kloter === k);
                const isKhatam = dataK.filter(d => d.nama.includes("‚úÖ")).length === 30;
                
                if (!isKhatam) {
                    const btn = document.createElement('button');
                    btn.className = `px-5 py-2 rounded-full border text-xs font-bold transition-all whitespace-nowrap ${currentSelectedKloter == k ? 'btn-kloter-active' : 'bg-white text-slate-600 border-slate-200'}`;
                    btn.innerText = `Kloter ${k}`;
                    btn.onclick = () => { currentSelectedKloter = k; renderJuzGrid(); };
                    selector.appendChild(btn);
                }
            });

            const grid = document.getElementById('juz-grid');
            grid.innerHTML = '';
            databaseGlobal.filter(d => d.kloter == currentSelectedKloter).forEach(item => {
                const isTaken = item.nama !== "";
                const isDone = item.nama.includes("‚úÖ");
                const card = document.createElement('div');
                card.className = `p-3 rounded-xl border-2 text-center transition-all cursor-pointer ${isTaken ? 'bg-slate-100 border-slate-300' : 'bg-emerald-50 border-emerald-200 hover:border-emerald-500 shadow-sm'}`;
                card.innerHTML = `<div class="text-[10px] font-bold text-emerald-700">JUZ</div><div class="text-lg font-black text-slate-800">${item.juz}</div><div class="text-[9px] truncate mt-1 ${isDone ? 'text-emerald-600 font-bold' : 'text-slate-500'}">${isTaken ? item.nama : 'Tersedia'}</div>`;
                card.onclick = () => handleAction(item.kloter, item.juz, isTaken, item.nama);
                grid.appendChild(card);
            });
        }

        
        async function handleAction(kloter, juz, isTaken, pendaftar) {
            if (!isTaken) {
                const nama = prompt(`Daftar Juz ${juz} Kloter ${kloter}. Nama Anda:`);
                if (nama && nama.trim() !== "") {
                    alert("Sedang mendaftarkan...");
                    await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ kloter, juz, nama }) });
                    
                    // Logika Tambah Kloter Baru: Jika yang didaftar adalah Juz 30 di kloter terakhir
                    const maxKloter = Math.max(...databaseGlobal.map(d => d.kloter));
                    if (juz === 30 && kloter === maxKloter) {
                        alert("Juz 30 Terisi! Menyiapkan Kloter Baru...");
                    }
                    
                    location.reload();
                }
            } else {
                showQuranText(juz, 'juz', pendaftar, kloter);
            }
        }
async function showQuranText(id, type, pendaftar = "", kloter = "") {
    const section = document.getElementById('read-section');
    const container = document.getElementById('quran-container');
    section.classList.remove('hidden');
    container.innerHTML = `<div class="text-center py-20 text-emerald-600 font-bold animate-pulse">Membuka Mushaf...</div>`;
    container.scrollIntoView({ behavior: 'smooth' });

    const endpoint = type === 'juz' ? `juz/${id}` : `surah/${id}`;
    const lastKey = `prog-${type}-${id}`;
    const lastAyat = localStorage.getItem(lastKey);

    try {
        const [resA, resI] = await Promise.all([
            fetch(`https://api.alquran.cloud/v1/${endpoint}/quran-uthmani`),
            fetch(`https://api.alquran.cloud/v1/${endpoint}/id.indonesian`)
        ]);
        const dataA = await resA.json();
        const dataI = await resI.json();

        // Perbaikan Penentuan Nama & Subjudul
        const title = type === 'juz' ? `Juz ${id}` : dataA.data.englishName;
        let subTitle = "";
        if (type === 'juz') {
            subTitle = pendaftar ? `Pembaca: ${pendaftar} (Kloter ${kloter})` : `Kloter ${kloter}`;
        } else {
            subTitle = `Surah ke-${dataA.data.number} ‚Ä¢ ${dataA.data.revelationType}`;
        }

        container.innerHTML = `
            <div class="bg-emerald-800 text-white p-4 rounded-xl flex justify-between items-center sticky top-[130px] z-40 shadow-lg">
                <div>
                    <h3 class="font-bold">${title}</h3>
                    <p class="text-[9px] opacity-80">${subTitle}</p>
                </div>
                <div class="flex gap-2">
                    ${lastAyat ? `<button onclick="document.getElementById('ayat-${lastAyat}').scrollIntoView({behavior:'smooth'})" class="bg-white text-emerald-800 text-[10px] px-3 py-2 rounded-full font-bold">Lanjut</button>` : ''}
                    ${type === 'juz' && pendaftar && !pendaftar.includes("‚úÖ") ? `<button onclick="finishSetoran(${id}, '${pendaftar}', ${kloter})" class="bg-yellow-400 text-emerald-900 text-[10px] px-3 py-2 rounded-full font-bold shadow-md">Setoran ‚úÖ</button>` : ''}
                </div>
            </div>`;

        const ayahs = dataA.data.ayahs;
        
        ayahs.forEach((ayat, i) => {
            // LOGIKA KRUSIAL: Membedakan cara ambil nomor surah & nama surah
            const surahName = type === 'juz' ? ayat.surah.englishName : dataA.data.englishName;
            const surahNum = type === 'juz' ? ayat.surah.number : dataA.data.number;
            const ayatId = `${surahNum}-${ayat.numberInSurah}`;
            
            const active = lastAyat === ayatId;
            
            const div = document.createElement('div');
            div.id = `ayat-${ayatId}`;
            div.className = `bg-white p-8 rounded-xl border-b-4 mb-4 cursor-pointer transition-all hover:bg-emerald-50 ${active ? 'border-emerald-500 ring-2 ring-emerald-100' : 'border-slate-100'}`;
            div.onclick = () => { 
                localStorage.setItem(lastKey, ayatId); 
                alert("Posisi membaca disimpan!"); 
                showQuranText(id, type, pendaftar, kloter); 
            };
            div.innerHTML = `
                <div class="text-right">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] text-slate-400 font-bold bg-slate-100 px-2 py-1 rounded">${surahName} : ${ayat.numberInSurah}</span>
                    </div>
                    <p class="arabic text-3xl leading-[4.5rem] text-slate-900" dir="rtl">${ayat.text}</p>
                    <p class="text-sm text-slate-600 text-left mt-6 leading-relaxed border-t pt-4 italic">${dataI.data.ayahs[i].text}</p>
                </div>`;
            container.appendChild(div);
        });
    } catch (e) { 
        console.error(e);
        container.innerHTML = `<div class="p-10 text-center text-red-500">Gagal memuat ayat. Pastikan koneksi internet stabil.</div>`; 
    }
}



        

        async function finishSetoran(juz, nama, kloter) {
            if (confirm(`Alhamdulillah, selesaikan setoran Juz ${juz} Kloter ${kloter}?`)) {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ kloter, juz, nama, selesai: true }) });
                location.reload();
            }
        }

        async function loadSurahList() {
            const container = document.getElementById('surah-grid');
            if (container.innerHTML !== '') return;
            container.innerHTML = '<div class="col-span-full text-center py-20">Memuat Daftar Surah...</div>';
            try {
                const res = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await res.json();
                container.innerHTML = '';
                data.data.forEach(s => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer hover:bg-emerald-50";
                    card.onclick = () => showQuranText(s.number, 'surah');
                    card.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-xs bg-emerald-100 text-emerald-700 w-8 h-8 flex items-center justify-center rounded-full font-bold">${s.number}</span>
                            <div><p class="text-sm font-bold text-slate-800">${s.englishName}</p></div>
                        </div>
                        <div class="arabic text-xl text-emerald-700">${s.name}</div>`;
                    container.appendChild(card);
                });
            } catch (e) { container.innerHTML = "Gagal memuat surah."; }
        }

        function switchTab(type) {
            document.getElementById('section-juz').classList.toggle('hidden', type !== 'juz');
            document.getElementById('section-surah').classList.toggle('hidden', type !== 'surah');
            document.getElementById('dashboard-area').classList.toggle('hidden', type !== 'juz');
            document.getElementById('read-section').classList.add('hidden');
            document.getElementById('tab-juz').className = `flex-1 py-4 text-center ${type === 'juz' ? 'tab-active' : 'text-slate-500'}`;
            document.getElementById('tab-surah').className = `flex-1 py-4 text-center ${type === 'surah' ? 'tab-active' : 'text-slate-500'}`;
            if (type === 'surah') loadSurahList();
        }

        init();
    </script>
</body>
</html>




