<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NgajiYuk - Tadarus 30 Juz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        .arabic { font-family: 'Amiri', serif; }
        .sticky-header { position: sticky; top: 0; z-index: 50; }
        .tab-active { border-bottom: 4px solid #10b981; color: #065f46; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-50 font-['Inter']">

    <nav class="bg-emerald-700 p-4 text-white shadow-lg sticky-header">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold italic">ðŸ“– NGAJIYUK</h1>
            <div class="text-[10px] bg-emerald-800 px-2 py-1 rounded">Online</div>
        </div>
    </nav>

    <div class="bg-white shadow-sm mb-4">
        <div class="container mx-auto flex">
            <button onclick="switchTab('juz')" id="tab-juz" class="flex-1 py-4 text-center tab-active">Jadwal Juz</button>
            <button onclick="switchTab('surah')" id="tab-surah" class="flex-1 py-4 text-center text-slate-500">Daftar Surah</button>
        </div>
    </div>

    <section id="dashboard-area" class="container mx-auto p-4">
    </section>
    
    <section id="section-juz" class="container mx-auto p-4">
        <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
            <h2 class="text-xl font-bold mb-4 text-slate-800 text-center sm:text-left">Pilih Jadwal Juz</h2>
            <div id="juz-grid" class="grid grid-cols-3 sm:grid-cols-5 md:grid-cols-10 gap-2">
                <div class="col-span-full text-center py-4 text-slate-400 italic text-sm">Menghubungkan ke Sheets...</div>
            </div>
        </div>
    </section>

    <section id="section-surah" class="container mx-auto p-4 hidden">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="surah-grid"></div>
    </section>
    
    <section id="read-section" class="container mx-auto p-4 hidden">
        <div id="quran-container" class="space-y-4"></div>
    </section>

    <script>
        // MASUKKAN URL APPS SCRIPT KAMU DI SINI
        const scriptURL = 'https://script.google.com/macros/s/AKfycby52vz1IOIJLBlu4wD3DDtFvjbyFFWpXaUbE0D8kMzYIR0odo6FLLVSbLQu-4j4hUS_cQ/exec';

        function switchTab(type) {
            document.getElementById('section-juz').classList.toggle('hidden', type !== 'juz');
            document.getElementById('section-surah').classList.toggle('hidden', type !== 'surah');
            document.getElementById('read-section').classList.add('hidden');
            document.getElementById('tab-juz').className = `flex-1 py-4 text-center ${type === 'juz' ? 'tab-active' : 'text-slate-500'}`;
            document.getElementById('tab-surah').className = `flex-1 py-4 text-center ${type === 'surah' ? 'tab-active' : 'text-slate-500'}`;
            if (type === 'surah') loadSurahList();
        }

        async function loadJadwal() {
            try {
                const response = await fetch(scriptURL);
                const data = await response.json();
                const container = document.getElementById('juz-grid');
                container.innerHTML = '';
                data.forEach(item => {
                    const isTaken = item.nama !== "";
                    const isDone = item.nama.includes("âœ…");
                    const card = document.createElement('div');
                    card.className = `p-3 rounded-xl border-2 text-center transition-all cursor-pointer ${isTaken ? 'bg-slate-100 border-slate-300' : 'bg-emerald-50 border-emerald-200 hover:border-emerald-500 shadow-sm'}`;
                    card.innerHTML = `
                        <div class="text-[10px] font-bold text-emerald-700">JUZ</div>
                        <div class="text-lg font-black">${item.juz}</div>
                        <div class="text-[9px] truncate font-medium ${isDone ? 'text-emerald-600' : 'text-slate-500'}">
                            ${isTaken ? item.nama : 'Tersedia'}
                        </div>
                    `;
                    card.onclick = () => handleJuzAction(item.juz, isTaken, item.nama);
                    container.appendChild(card);
                });
            } catch (e) { console.error(e); }
        }

        async function handleJuzAction(nomor, isTaken, namaPendaftar) {
            if (!isTaken) {
                const nama = prompt(`Juz ${nomor} kosong. Masukkan nama Anda untuk mengambil:`);
                if (nama) {
                    await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ "juz": nomor, "nama": nama }) });
                    alert("Berhasil didaftarkan!"); location.reload();
                }
            } else {
                // Jika sudah diambil, langsung tampilkan suratnya
                showQuranText(nomor, 'juz', namaPendaftar);
            }
        }

        async function showQuranText(id, type, pendaftar = "") {
            const section = document.getElementById('read-section');
            const container = document.getElementById('quran-container');
            section.classList.remove('hidden');
            container.innerHTML = `<div class="text-center py-20 text-emerald-600 font-bold">Sedang memuat isi Al-Qur'an...</div>`;
            container.scrollIntoView({ behavior: 'smooth' });

            const endpoint = type === 'juz' ? `juz/${id}` : `surah/${id}`;
            const lastKey = `last-read-${type}-${id}`;
            const lastAyat = localStorage.getItem(lastKey);

            try {
                const [resArab, resIndo] = await Promise.all([
                    fetch(`https://api.alquran.cloud/v1/${endpoint}/quran-uthmani`),
                    fetch(`https://api.alquran.cloud/v1/${endpoint}/id.indonesian`)
                ]);
                const dataArab = await resArab.json();
                const dataIndo = await resIndo.json();

                container.innerHTML = `
                    <div class="bg-emerald-800 text-white p-4 rounded-xl flex flex-col gap-3 sticky top-[130px] z-40 shadow-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold">Membaca ${type === 'juz' ? 'Juz ' + id : dataArab.data.englishName}</h3>
                            <div class="flex gap-2">
                                ${lastAyat ? `<button onclick="document.getElementById('ayat-${lastAyat}').scrollIntoView({behavior:'smooth'})" class="bg-white text-emerald-800 text-[10px] px-3 py-2 rounded-full font-bold shadow-md">Lanjut</button>` : ''}
                                ${type === 'juz' && !pendaftar.includes("âœ…") ? `<button onclick="setoranSelesai(${id}, '${pendaftar}')" class="bg-yellow-400 text-emerald-900 text-[10px] px-3 py-2 rounded-full font-bold shadow-md">Setoran âœ…</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                dataArab.data.ayahs.forEach((ayat, index) => {
                    const ayatId = type === 'juz' ? `${ayat.surah.number}-${ayat.numberInSurah}` : `${id}-${ayat.numberInSurah}`;
                    const isLastRead = lastAyat === ayatId;
                    const div = document.createElement('div');
                    div.id = `ayat-${ayatId}`;
                    div.className = `bg-white p-6 rounded-xl border-b-4 mb-4 cursor-pointer transition-all ${isLastRead ? 'border-emerald-500 bg-emerald-50' : 'border-slate-100'}`;
                    div.onclick = () => {
                        localStorage.setItem(lastKey, ayatId);
                        alert("Tanda baca disimpan!");
                        showQuranText(id, type, pendaftar);
                    };
                    div.innerHTML = `
                        <div class="text-right">
                            <div class="flex justify-between items-center mb-4"><span class="text-[10px] text-slate-400">${ayat.surah.englishName} : ${ayat.numberInSurah}</span></div>
                            <p class="arabic text-3xl leading-[4.5rem] text-slate-900" dir="rtl">${ayat.text}</p>
                            <p class="text-sm text-slate-600 text-left mt-4 leading-relaxed">${dataIndo.data.ayahs[index].text}</p>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (e) { container.innerHTML = "Gagal memuat teks Al-Qur'an."; }
        }

        async function setoranSelesai(nomor, nama) {
            if (confirm("Alhamdulillah, apakah sudah selesai mengaji Juz ini?")) {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ "juz": nomor, "nama": nama, "selesai": true }) });
                alert("Barakallah! Laporan tersimpan."); location.reload();
            }
        }

        async function loadSurahList() {
            const container = document.getElementById('surah-grid');
            container.innerHTML = 'Memuat surah...';
            const res = await fetch('https://api.alquran.cloud/v1/surah');
            const data = await res.json();
            container.innerHTML = '';
            data.data.forEach(s => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center cursor-pointer hover:bg-emerald-50";
                card.onclick = () => showQuranText(s.number, 'surah');
                card.innerHTML = `<div class="flex items-center gap-3"><span class="text-xs bg-slate-100 w-8 h-8 flex items-center justify-center rounded-full">${s.number}</span><div><p class="text-sm font-bold">${s.englishName}</p></div></div><div class="arabic text-xl text-emerald-700">${s.name}</div>`;
                container.appendChild(card);
            });
        }

        loadJadwal();

        let databaseGlobal = [];

// 1. Fungsi untuk Memproses Data Kloter & Dashboard
function renderJuzGrid(data) {
    databaseGlobal = data; // Simpan untuk dashboard
    const container = document.getElementById('juz-grid');
    container.innerHTML = '';
    
    // Kelompokkan data berdasarkan kloter
    const kloters = [...new Set(data.map(item => item.kloter))];
    const kloterTerakhir = Math.max(...kloters);
    
    // Cek apakah kloter terakhir sudah penuh (semua 30 juz ada namanya)
    const kloterTerakhirData = data.filter(d => d.kloter === kloterTerakhir);
    const isPenuh = kloterTerakhirData.every(d => d.nama !== "");
    
    // TAMPILKAN DASHBOARD
    updateDashboard(data, kloters);

    // TAMPILKAN GRID KLOTER (Kita tampilkan kloter terakhir atau pilihan user)
    const targetKloter = isPenuh ? kloterTerakhir + 1 : kloterTerakhir;
    
    // Jika kloter baru belum ada di database, kita buat tampilan dummy (user akan otomatis nambah ke sheet saat daftar)
    const dataTampil = data.filter(d => d.kloter === kloterTerakhir);

    // Render Judul Kloter Aktif
    container.innerHTML = `<div class="col-span-full font-bold text-center mb-2 text-emerald-800">Menampilkan Kloter ${kloterTerakhir} ${isPenuh ? '(Penuh - Menunggu Kloter Baru)' : ''}</div>`;

    dataTampil.forEach(item => {
        const isTaken = item.nama !== "";
        const card = document.createElement('div');
        card.className = `p-3 rounded-xl border-2 text-center cursor-pointer ${isTaken ? 'bg-slate-100' : 'bg-emerald-50 border-emerald-200'}`;
        card.innerHTML = `<div>Juz ${item.juz}</div><div class="text-[9px] truncate">${isTaken ? item.nama : 'Pilih'}</div>`;
        card.onclick = () => handleJuzAction(item.kloter, item.juz, isTaken, item.nama);
        container.appendChild(card);
    });
}

// 2. Dashboard Capaian
function updateDashboard(data, kloters) {
    const dashboardContainer = document.getElementById('dashboard-area'); // Buat elemen ini di HTML
    if(!dashboardContainer) return;
    
    dashboardContainer.innerHTML = '<h2 class="font-bold mb-3">Dashboard Capaian Kloter</h2>';
    
    kloters.forEach(k => {
        const dataK = data.filter(d => d.kloter === k);
        const selesai = dataK.filter(d => d.nama.includes("âœ…")).length;
        const terisi = dataK.filter(d => d.nama !== "").length;
        const persen = Math.round((selesai / 30) * 100);

        dashboardContainer.innerHTML += `
            <div class="mb-4 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="flex justify-between text-xs mb-1">
                    <span>Kloter ${k} (${terisi}/30 Terisi)</span>
                    <span class="font-bold">${persen}% Khatam</span>
                </div>
                <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                    <div class="bg-emerald-500 h-full" style="width: ${persen}%"></div>
                </div>
            </div>
        `;
    });
}

// 3. Update Fungsi handleJuzAction untuk mendukung kloter
async function handleJuzAction(kloter, juz, isTaken, namaPendaftar) {
    if (!isTaken) {
        const nama = prompt(`Daftar Juz ${juz} Kloter ${kloter}:`);
        if (nama) {
            await fetch(scriptURL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ "kloter": kloter, "juz": juz, "nama": nama }) 
            });
            location.reload();
        }
    } else {
        showQuranText(juz, 'juz', namaPendaftar, kloter);
    }
}
    </script>
</body>
</html>

